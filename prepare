#!/bin/bash

set_dockerfile() {
  # If alpine is selected, use the alpine Dockerfile;
  if [[ "$1" == "alpine"* ]]; then 
    DOCKERFILE=DockerfileAlpine; 
  # If centos is selected, use the centos Dockerfile
  elif [[ "$1" == "centos"* ]]; then
    DOCKERFILE=DockerfileCentos;
  else 
    DOCKERFILE=Dockerfile; 
  fi
}

warmup() {
  echo -e "\n# warmup\n" >> logs/experiment-"${EXPID}"/"${WORKLOAD}"/warmup.txt
  sysbench cpu --time=`expr ${WARMUP} \* $(nproc)` --threads=$(nproc) run | tee -a logs/experiment-"${EXPID}"/"${WORKLOAD}"/warmup.txt
  echo -e "\n\n" >> logs/experiment-"${EXPID}"/"${WORKLOAD}"/warmup.txt
}

# Default values
EXPID=-1
WORKLOAD="llama.cpp"
BASE=()
WARMUP=10
OPTIONS=()
COMMAND=()
ISOLATE=""
BACKGROUND=""

# Get the arguments
while getopts "x:l:b:w:o:c:i:j:" arg; do
  case $arg in
    x) EXPID=$OPTARG;;
    l) WORKLOAD=$OPTARG;;
    b) BASE+=("$OPTARG");;
    w) WARMUP=$OPTARG;;
    o)
      IFS=' ' read -r FLAG ARG <<< "${OPTARG}"
      OPTIONS+=("${FLAG}" "${ARG}");;
    c)
      IFS=' ' read -r FLAG ARG <<< "${OPTARG}"
      COMMAND+=("${FLAG}" "${ARG}");;
    i) ISOLATE=$OPTARG;;
    j) BACKGROUND=$OPTARG;;
    *) ;;
  esac
done

# Setup the log files
mkdir -p logs/experiment-"${EXPID}"/"${WORKLOAD}"
mkdir -p results/experiment-"${EXPID}"/"${WORKLOAD}"

echo -e "### experiment ${EXPID} ###\n# cpus: ${ISOLATE}\n# workload: ${WORKLOAD}\n" | tee -a logs/experiment-"${EXPID}"/"${WORKLOAD}"/warmup.txt \
  logs/experiment-"${EXPID}"/"${WORKLOAD}"/info.txt
date +"# started on %c %n" >> logs/experiment-"${EXPID}"/"${WORKLOAD}"/warmup.txt

# Build the Docker images and run the workload once for each base image as warm-up
for i in "${BASE[@]}"; do
  # echo -e "### experiment ${EXPID} ###\n# cpus: ${ISOLATE}\n# workload: ${WORKLOAD}\n# image: ${i}\n" | tee -a \
  # logs/experiment-"${EXPID}"/"${WORKLOAD}"/"${i/:/}".txt \
  # results/experiment-"${EXPID}"/"${WORKLOAD}"/"${i/:/}".txt
  mkdir -p logs/experiment-"${EXPID}"/"${WORKLOAD}"/"${i/:/}"
  mkdir -p results/experiment-"${EXPID}"/"${WORKLOAD}"/"${i/:/}"


  set_dockerfile "${i}"
  
  NAME="${i/:/}" FILE="${DOCKERFILE}" IMAGE="${i}" ISOLATE_CPU="${ISOLATE}" BACKGROUND_CPU="${BACKGROUND}" docker compose -f workloads/"${WORKLOAD}"/docker-compose.yml build

  NAME="${i/:/}" FILE="${DOCKERFILE}" IMAGE="${i}" ISOLATE_CPU="${ISOLATE}" BACKGROUND_CPU="${BACKGROUND}" docker compose -f workloads/"${WORKLOAD}"/docker-compose.yml up --abort-on-container-exit

  NAME="${i/:/}" FILE="${DOCKERFILE}" IMAGE="${i}" ISOLATE_CPU="${ISOLATE}" BACKGROUND_CPU="${BACKGROUND}" docker compose -f workloads/"${WORKLOAD}"/docker-compose.yml down
done

# Log the docker images information
echo -e "# docker images\n" >> logs/experiment-"${EXPID}"/"${WORKLOAD}"/info.txt
docker image ls | egrep "REPOSITORY|${WORKLOAD}" >> logs/experiment-"${EXPID}"/"${WORKLOAD}"/info.txt
echo -e "\n# total order\n" >> logs/experiment-"${EXPID}"/"${WORKLOAD}"/info.txt

# Start the warm up procedure
warmup

