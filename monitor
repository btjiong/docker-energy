#!/bin/bash

# Default values
BASE="ubuntu"
NUMBER=1
INFERENCE="Building a website can be done in 10 simple steps:"
TOKENS=512
EXPID=-1
OPTIONS=()
COMMAND=()

# Get the arguments
while getopts "b:n:i:t:x:r:w:ao:c:" arg; do
  case $arg in
    b) BASE=$OPTARG;;
    n) NUMBER=$OPTARG;;
    i) INFERENCE=$OPTARG;;
    t) TOKENS=$OPTARG;;
    x) EXPID=$OPTARG;;
    r) RUN=$OPTARG;;
    w) WORKLOAD=$OPTARG;;
    o) OPTIONS+=("$OPTARG");;
    c) COMMAND+=("$OPTARG");;
#    a) BASE=("ubuntu" "debian" "alpine" "centos");;
    *) ;;
  esac
done


if [[ "$WORKLOAD" == "llama.cpp" ]]; then
  OPTIONS=(-v "${PWD}"/llama.cpp/models:/models)
  COMMAND=(-m /models/7B/ggml-model-q4_0.bin -p "${INFERENCE}" -n "${TOKENS}" --seed 12345678)
elif [[ "$WORKLOAD" == "video-stream" ]]; then
  OPTIONS=(-p 8080:8080 --add-host=host.docker.internal:host-gateway)
fi

# Start the prepare procedure: building images and warming up the machine
# . prepare -u "${RUNID}" -b "${BASE}"

# Run and monitor the workload for the specified number of times
# for ((i=1; i<=NUMBER; i++)); do
sleep 10
echo -e "# run ${RUN}: ${BASE}" | tee -a results/"${WORKLOAD}"_"${BASE}".txt

# Run the monitoring tool on the docker run command
perf stat -o results/"${WORKLOAD}"_"${BASE}".txt --append -e power/energy-cores/,power/energy-ram/,power/energy-gpu/,power/energy-pkg/ \
docker run --name "${WORKLOAD}"-"${BASE}" "${OPTIONS[@]}" "${WORKLOAD}"-"${BASE}" "${COMMAND[@]}"

# Log the output of the run
date +"# run ${RUN}%n# started on %c %n" >> logs/"${WORKLOAD}"_"${BASE}".txt
docker logs -f "${WORKLOAD}"-"${BASE}" &>> logs/"${WORKLOAD}"_"${BASE}".txt
echo -e "\n\n" | tee -a logs/"${WORKLOAD}"_"${BASE}".txt results/"${WORKLOAD}"_"${BASE}".txt
docker rm "${WORKLOAD}"-"${BASE}"
# done

# Remove the docker images of this experiment
# for i in "${BASE[@]}"; do
#   docker rmi llama.cpp-"${i}"
# done