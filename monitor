#!/bin/bash

# Default values
EXPID=-1
WORKLOAD="llama.cpp"
BASE="ubuntu"
PAUSE=15
OPTIONS=()
COMMAND=()
ISOLATE=""
BACKGROUND=""
CLIENT=false
COMPOSE=false

# Get the arguments
while getopts "x:l:b:p:o:c:i:j:r:" arg; do
  case $arg in
    x) EXPID=$OPTARG;;
    l) WORKLOAD=$OPTARG;;
    b) BASE=$OPTARG;;
    p) PAUSE=$OPTARG;;
    o)
      IFS=' ' read -r FLAG ARG <<< "${OPTARG}"
      OPTIONS+=("${FLAG}" "${ARG}");;
    c)
      IFS=' ' read -r FLAG ARG <<< "${OPTARG}"
      COMMAND+=("${FLAG}" "${ARG}");;
    i) ISOLATE=$OPTARG;;
    j) BACKGROUND=$OPTARG;;
    r) RUN=$OPTARG;;
    *) ;;
  esac
done

# Setup the default options and commands for the Docker run command
if [[ "$WORKLOAD" == "llama.cpp" ]]; then
  if [[ ${#OPTIONS[@]} -eq 0 ]]; then
    OPTIONS=(-v "${PWD}"/llama.cpp/models:/models)
  fi
  if [[ ${#COMMAND[@]} -eq 0 ]]; then
    COMMAND=(-m /models/7B/ggml-model-q4_0.bin -p "Building a website can be done in 10 simple steps:" -n 64 --seed 12345678 -t 2)
  fi
elif [[ "$WORKLOAD" == "nginx-vod-module-docker" ]]; then
  if [[ ${#OPTIONS[@]} -eq 0 ]]; then
    OPTIONS=(-p 3030:80 -v "${PWD}"/nginx-vod-module-docker/examples/videos:/opt/static/videos -v "${PWD}"/workloads/nginx-vod-module-docker/nginx.conf:/usr/local/nginx/conf/nginx.conf)
  fi
  CLIENT=true
elif [[ "$WORKLOAD" == "cypress-realworld-app" ]]; then
  # if [[ ${#OPTIONS[@]} -eq 0 ]]; then
  #   OPTIONS=(-p 3001:3001)
  # fi
  CLIENT=true
  COMPOSE=true
elif [[ "$WORKLOAD" == "mattermost" ]]; then
  CLIENT=true
  COMPOSE=true
fi


# Run and monitor the workload for the specified number of times
sleep "${PAUSE}"
echo -e "# run ${RUN}: ${BASE}" | tee -a results/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt \
results/"${WORKLOAD}"-"${EXPID}"/samples/"${BASE/:/}".txt

# Run the monitoring tool on the docker run command
# stdbuf -i0 -o0 -e0 powerstat -R 0.5 1024 -n &>> results/"${WORKLOAD}"-"${EXPID}"/samples/"${BASE/:/}".txt &
# PID=$!

if ${CLIENT} ; then
  bash workloads/"${WORKLOAD}"/client -b "${BASE}" &
fi

if ${COMPOSE} ; then
  NAME="${BASE/:/}" perf stat -o results/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt --append -e power/energy-cores/,power/energy-ram/,power/energy-gpu/,power/energy-pkg/ \
  docker compose -f workloads/"${WORKLOAD}"/docker-compose.yml up
else
  perf stat -o results/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt --append -e power/energy-cores/,power/energy-ram/,power/energy-gpu/,power/energy-pkg/ \
  docker run --name "${WORKLOAD}"-"${BASE/:/}" --cpuset-cpus "${ISOLATE}" "${OPTIONS[@]}" "${WORKLOAD}"-"${BASE/:/}" "${COMMAND[@]}"
fi


# kill -9 $PID

# Log the output of the run
date +"# run ${RUN}%n# started on %c %n" >> logs/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt
docker logs -f "${WORKLOAD}"-"${BASE/:/}" &>> logs/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt
echo -e "\n\n" | tee -a logs/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt results/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt
#docker rm "${WORKLOAD}"-"${BASE}"
if ! ${COMPOSE} ; then
  docker rm "${WORKLOAD}"-"${BASE/:/}"
fi
