#!/bin/bash

# Default values
EXPID=-1
WORKLOAD="llama.cpp"
BASE="ubuntu"
PAUSE=15
OPTIONS=()
COMMAND=()
ISOLATE=""
BACKGROUND=""

# Get the arguments
while getopts "x:l:b:p:o:c:i:j:r:s:" arg; do
  case $arg in
    x) EXPID=$OPTARG;;
    l) WORKLOAD=$OPTARG;;
    b) BASE=$OPTARG;;
    p) PAUSE=$OPTARG;;
    o)
      IFS=' ' read -r FLAG ARG <<< "${OPTARG}"
      OPTIONS+=("${FLAG}" "${ARG}");;
    c)
      IFS=' ' read -r FLAG ARG <<< "${OPTARG}"
      COMMAND+=("${FLAG}" "${ARG}");;
    i) ISOLATE=$OPTARG;;
    j) BACKGROUND=$OPTARG;;
    r) RUN=$OPTARG;;
    s) SCALE="--scale client=${OPTARG}";;
    *) ;;
  esac
done

# Run and monitor the workload for the specified number of times
sleep "${PAUSE}"
echo -e "# run ${RUN}: ${BASE}" | tee -a results/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt

date +"# run ${RUN}%n# started on %c %n" >> logs/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt

# Run the monitoring tool on the docker run command
# NAME="${BASE/:/}" FILE="${DOCKERFILE}" IMAGE="${BASE}" ISOLATE_CPU="${ISOLATE}" BACKGROUND_CPU="${BACKGROUND}" perf stat -I 100 -x "\t" -o results/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt --append -C "${ISOLATE}" -e power/energy-pkg/ \
# docker compose -f workloads/"${WORKLOAD}"/docker-compose.yml up ${SCALE} --abort-on-container-exit 2>&1 | tee -a logs/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt
NAME="${BASE/:/}" FILE="${DOCKERFILE}" IMAGE="${BASE}" ISOLATE_CPU="${ISOLATE}" BACKGROUND_CPU="${BACKGROUND}" perf stat -o results/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt --append -C "${ISOLATE}" -e power/energy-pkg/ \
docker compose -f workloads/"${WORKLOAD}"/docker-compose.yml up ${SCALE} --abort-on-container-exit 2>&1 | tee -a logs/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt

# Log the output of the run
echo -e "\n\n" | tee -a logs/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt results/"${WORKLOAD}"-"${EXPID}"/"${BASE/:/}".txt

# Remove the containers
NAME="${BASE/:/}" FILE="${DOCKERFILE}" IMAGE="${BASE}" ISOLATE_CPU="${ISOLATE}" BACKGROUND_CPU="${BACKGROUND}" docker compose -f workloads/"${WORKLOAD}"/docker-compose.yml down
